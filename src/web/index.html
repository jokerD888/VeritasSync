<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VeritasSync æ§åˆ¶å°</title>
        <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --surface: #fff;
            --text: #111827;
            --sub: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex
        }

        .sidebar {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 10
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .nav-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--sub);
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-weight: 500;
            transition: 0.2s
        }

        .nav-item:hover,
        .nav-item.active {
            background: #eff6ff;
            color: var(--primary)
        }

        .main {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            overflow-y: auto;
            height: 100vh
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600
        }

        .section-hidden {
            display: none !important
        }

        .card {
            background: var(--surface);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 0 2px #d1fae5
        }

        /* å‘¼å¸ç¯åŠ¨ç”» */
        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .dot.online {
            animation: pulse-green 2s infinite;
        }

        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem
        }

        .task-card {
            background: var(--surface);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: 0.2s;
            display: flex;
            flex-direction: column
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1)
        }

        .task-header {
            padding: 1rem;
            background: #f9fafb;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600
        }

        .role {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.7rem;
            text-transform: uppercase
        }

        .role-src {
            background: #dbeafe;
            color: #1e40af
        }

        .role-dst {
            background: #e0e7ff;
            color: #3730a3
        }

        .role-bi {
            background: #f3e8ff;
            color: #6b21a8;
            border: 1px solid #e9d5ff;
        }

        .role-bi {
            background: #f3e8ff;
            color: #6b21a8;
            border: 1px solid #e9d5ff;
        }

        .task-body {
            padding: 1rem;
            flex: 1
        }

        .info-item {
            margin-bottom: 0.8rem
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--sub);
            margin-bottom: 2px
        }

        .info-val {
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            word-break: break-all;
            cursor: pointer
        }

        .info-val:hover {
            background: #e5e7eb
        }

        .task-footer {
            padding: 0.8rem 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            justify-content: center;
            white-space: nowrap
        }

        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none
        }

        .btn-primary:hover {
            background: #1d4ed8
        }

        .btn-danger {
            background: #fff1f2;
            color: var(--danger);
            border-color: #fecdd3
        }

        .btn-danger:hover {
            background: #fee2e2
        }

        .form-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-top: 4px
        }

        .form-group {
            margin-bottom: 1rem
        }

        .input-group {
            display: flex;
            gap: 8px
        }

        /* å¢å¼ºç‰ˆæ—¥å¿—æ ·å¼ */
        .log-container {
            background: #1e1e1e;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            height: 65vh;
            overflow-y: auto;
            border: 1px solid #374151;
            white-space: pre-wrap
        }

        .log-line {
            padding: 2px 0;
            border-bottom: 1px solid #2d2d2d;
        }

        .log-info {
            color: #a7f3d0;
        }

        .log-warn {
            color: #fcd34d;
        }

        .log-error {
            color: #fca5a5;
            font-weight: bold;
        }

        .log-debug {
            color: #9ca3af;
        }

        .log-time {
            color: #6b7280;
            margin-right: 8px;
        }

        .log-toolbar {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 50;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px)
        }

        .modal.open {
            display: flex
        }

        .modal-box {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 480px;
            max-width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1)
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            display: none
        }

        .overlay.active {
            display: flex
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        /* --- ä¼ è¾“åˆ—è¡¨ç¾åŒ–æ ·å¼ --- */
        .transfer-item {
            margin-bottom: 1rem;
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: 0.2s;
        }

        .transfer-item:hover {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .transfer-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 8px;
            align-items: center;
        }

        .transfer-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 8px;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .badge-up {
            background: #dbeafe;
            color: #1e40af;
        }

        /* è“è‰² Upload */
        .badge-down {
            background: #d1fae5;
            color: #065f46;
        }

        /* ç»¿è‰² Download */

        .progress-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        /* åŠ¨æ€æ¡çº¹åŠ¨ç”» */
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            /* æ¡çº¹èƒŒæ™¯ */
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .2) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }

        .fill-up {
            background-color: #3b82f6;
        }

        /* è“è‰² */
        .fill-down {
            background-color: #10b981;
        }

        /* ç»¿è‰² */

        @keyframes progress-stripes {
            0% {
                background-position: 1rem 0;
            }

            100% {
                background-position: 0 0;
            }
        }

        .transfer-meta {
            font-size: 11px;
            color: #6b7280;
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
        }
        </style>
    </head>
    <body>
        <div class="overlay" id="restart-overlay">
            <div class="spinner"></div>
            <h2>æ­£åœ¨é‡å¯åº”ç”¨ç¨‹åº...</h2>
            <p style="color:var(--sub)">è¯·ç¨å€™ï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°</p>
        </div>
        <div class="sidebar">
            <div class="brand">âš¡ VeritasSync</div>
            <div class="nav-item active" onclick="switchTab('dashboard', this)">ğŸ“Š æ€»è§ˆä»ªè¡¨ç›˜</div>
            <div class="nav-item" onclick="switchTab('settings', this)">âš™ï¸ å…¨å±€è®¾ç½®</div>
            <div class="nav-item" onclick="switchTab('logs', this)">ğŸ“œ ç³»ç»Ÿæ—¥å¿—</div>
        </div>
        <div class="main">
            <div id="view-dashboard" class="view-section">
                <div class="header">
                    <h1 class="page-title">ä»»åŠ¡ç®¡ç†</h1>
                    <button class="btn btn-primary" onclick="openModal()">+ æ–°å»ºä»»åŠ¡</button>
                </div>
                <div class="status-grid">
                    <div class="card">
                        <div style="color:var(--sub);font-size:0.875rem">Tracker</div>
                        <div class="stat-val">
                            <div class="dot online"></div>
                            åœ¨çº¿
                        </div>
                        <div style="font-size:12px;color:var(--sub);margin-top:4px" id="display-tracker-addr">è¿æ¥ä¸­...</div>
                    </div>
                    <div class="card">
                        <div style="color:var(--sub);font-size:0.875rem">æ´»è·ƒä»»åŠ¡</div>
                        <div class="stat-val" id="task-count">0</div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:1rem;display:flex;align-items:center;gap:8px">
                        ğŸš€ æ­£åœ¨ä¼ è¾“
                        <span id="transfer-count" style="font-size:0.8rem;background:#f3f4f6;padding:2px 8px;border-radius:12px;color:#666">0</span>
                    </h3>
                    <div id="transfer-container" style="min-height:60px">
                        <div style="text-align:center;padding:1.5rem;color:#9ca3af;font-size:0.9rem">âœ¨ æš‚æ— æ´»è·ƒä¼ è¾“</div>
                    </div>
                </div>
                <h3 style="margin-bottom:1rem">æˆ‘çš„åŒæ­¥ç›®å½•</h3>
                <div class="task-grid" id="task-container"></div>
            </div>
            <div id="view-settings" class="view-section section-hidden">
                <div class="header">
                    <h1 class="page-title">å…¨å±€é…ç½®</h1>
                    <div style="display:flex;gap:10px">
                        <button class="btn" onclick="restartApp()" id="btnRestart">
                            ğŸ”„
                        é‡å¯åº”ç”¨
                        </button>
                        <button class="btn btn-primary" onclick="saveSettings()" id="btnSave">
                            ğŸ’¾
                        ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                </div>
                <div class="card" style="max-width:600px">
                    <h3 style="margin-bottom:1.5rem">è¿æ¥è®¾ç½®</h3>
                    <div class="form-group">
                        <label>Tracker åœ°å€ (Host : Port)</label>
                        <div class="input-group">
                            <input
                                id="cfgTrackerHost"
                                class="form-input"
                                placeholder="IP æˆ–åŸŸå"
                                style="flex: 3;"
                            >
                            <input
                                id="cfgTrackerPort"
                                class="form-input"
                                type="number"
                                placeholder="ç«¯å£"
                                style="flex: 1;"
                            >
                        </div>
                    </div>
                    <hr style="margin:1.5rem 0;border:0;border-top:1px solid var(--border)">
                    <h3 style="margin-bottom:1.5rem">NAT ç©¿é€ (STUN/TURN)</h3>
                    <div class="form-group">
                        <label>STUN æœåŠ¡å™¨ (Host : Port)</label>
                        <div class="input-group">
                            <input
                                id="cfgStunHost"
                                class="form-input"
                                placeholder="stun.l.google.com"
                                style="flex: 3;"
                            >
                            <input
                                id="cfgStunPort"
                                class="form-input"
                                type="number"
                                placeholder="19302"
                                style="flex: 1;"
                            >
                        </div>
                        <div style="font-size:0.8rem;color:var(--sub);margin-top:4px">
                            å¤‡é€‰æ¨è: stun.l.google.com:19302
                        </div>
                    </div>
                    <div class="form-group">
                        <label>TURN æœåŠ¡å™¨ (å¯é€‰) (Host : Port)</label>
                        <div class="input-group">
                            <input
                                id="cfgTurnHost"
                                class="form-input"
                                placeholder="ç•™ç©ºä»¥ç¦ç”¨"
                                style="flex: 3;"
                            >
                            <input
                                id="cfgTurnPort"
                                class="form-input"
                                type="number"
                                placeholder="3478"
                                style="flex: 1;"
                            >
                        </div>
                    </div>
                    <div class="form-group">
                        <label>TURN ç”¨æˆ·å</label>
                        <input id="cfgTurnUser" class="form-input" value="">
                    </div>
                    <div class="form-group">
                        <label>TURN å¯†ç </label>
                        <input
                            id="cfgTurnPass"
                            class="form-input"
                            type="password"
                            value=""
                        >
                    </div>
                </div>
            </div>
            <div id="view-logs" class="view-section section-hidden">
                <div class="header">
                    <h1 class="page-title">è¿è¡Œæ—¥å¿—</h1>
                    <div class="log-toolbar">
                        <input
                            type="text"
                            id="logFilter"
                            class="form-input"
                            style="width:180px;margin:0;padding:0.4rem"
                            placeholder="ğŸ” å…³é”®è¯..."
                            onkeyup="renderLog()"
                        >
                        <label style="font-size:13px;cursor:pointer;display:flex;align-items:center;gap:4px">
                            <input type="checkbox" id="autoScroll" checked>
                            è‡ªåŠ¨æ»šåŠ¨
                        </label>
                        <button class="btn" onclick="fetchGlobalLog()">åˆ·æ–°</button>
                    </div>
                </div>
                <div class="log-container" id="global-log-area">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <div class="modal" id="add-modal">
            <div class="modal-box">
                <h2 style="margin-bottom:1.5rem">æ–°å»ºä»»åŠ¡</h2>
                <div class="form-group">
                    <label>Sync Key</label>
                    <div class="input-group">
                        <input
                            id="newKey"
                            class="form-input"
                            type="text"
                            autocomplete="off"
                            data-lpignore="true"
                            name="veritas_sync_key_field"
                            placeholder="ä¾‹å¦‚ï¼šproject-01"
                        >
                        <button class="btn" onclick="genKey()" style="margin-top:4px">ğŸ² ç”Ÿæˆ</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>åŒæ­¥æ¨¡å¼</label>
                    <select id="newMode" class="form-input" onchange="updateRoleVisibility()">
                        <option value="oneway">â¡ï¸ å•å‘åŒæ­¥ (Source â¡ï¸ Dest)</option>
                        <option value="bidirectional">ğŸ” åŒå‘åŒæ­¥ (ä¸¤ç«¯äº’ç›¸åŒæ­¥) </option>
                        </select>
                    </div>
                    <div class="form-group" id="role-group">
                        <label>è§’è‰²</label>
                        <select id="newRole" class="form-input">
                            <option value="source">Source (å‘é€ç«¯)</option>
                            <option value="destination">Destination (æ¥æ”¶ç«¯)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è·¯å¾„</label>
                        <div class="input-group">
                            <input id="newFolder" class="form-input">
                            <button class="btn" onclick="pickFolder()" style="margin-top:4px">ğŸ“‚ æµè§ˆ</button>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:2rem">
                        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="addTask()">åˆ›å»º</button>
                    </div>
                </div>
            </div>
            <div class="modal" id="log-modal">
                <div class="modal-box" style="width:800px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:1rem">
                        <h3>ä»»åŠ¡æ—¥å¿—</h3>
                        <button class="btn" onclick="closeLogModal()">å…³é—­</button>
                    </div>
                    <div class="log-container" id="task-log-content" style="height:400px"></div>
                </div>
            </div>
            <script>
        let rawLog = "";
        const id = x => document.getElementById(x);

        function updateRoleVisibility() {
            const mode = id('newMode').value;
            const roleGroup = id('role-group');
            
            if (mode === 'bidirectional') {
                // åŒå‘æ¨¡å¼ï¼šéšè—è§’è‰²é€‰æ‹©ï¼Œåå°é€»è¾‘å¤„ç†è§’è‰²
                roleGroup.style.display = 'none';
            } else {
                // å•å‘æ¨¡å¼ï¼šæ˜¾ç¤ºè§’è‰²é€‰æ‹©
                roleGroup.style.display = 'block';
            }
        }

        function openModal() { 
            id('add-modal').classList.add('open'); 
            // é‡ç½®è¡¨å•
            id('newMode').value = 'oneway'; 
            id('newRole').value = 'source'; 
            // æ ¹æ®é‡ç½®åçš„å€¼åˆ·æ–°UIçŠ¶æ€
            updateRoleVisibility();
        }

        function switchTab(i, e) {
            document.querySelectorAll('.view-section').forEach(x => x.classList.add('section-hidden'));
            id('view-' + i).classList.remove('section-hidden');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            e.classList.add('active');
            if (i === 'dashboard') loadTasks();
            if (i === 'settings') loadSettings();
            if (i === 'logs') fetchGlobalLog();
        }

        async function loadTasks() {
            try {
                const r = await fetch('/api/config');
                const c = await r.json();

                id('task-count').innerText = c.tasks.length;

                if (c.tracker_host) {
                    id('display-tracker-addr').innerText = `${c.tracker_host}:${c.tracker_port}`;
                }

                const container = id('task-container');

                if (c.tasks.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem; background: white; border-radius: 1rem; border: 2px dashed var(--border);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‘‹</div>
                            <h2 style="color: var(--text); margin-bottom: 0.5rem;">æ¬¢è¿ä½¿ç”¨ VeritasSync</h2>
                            <p style="color: var(--sub); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                                æ‚¨è¿˜æ²¡æœ‰é…ç½®ä»»ä½•åŒæ­¥ä»»åŠ¡ã€‚åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ¥å¼€å§‹åœ¨è®¾å¤‡é—´åŒæ­¥æ–‡ä»¶å§ï¼
                            </p>
                            <button class="btn btn-primary" style="padding: 0.75rem 1.5rem; font-size: 1rem;" onclick="openModal()">
                                âœ¨ åˆ›å»ºæˆ‘çš„ç¬¬ä¸€ä¸ªåŒæ­¥ä»»åŠ¡
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = c.tasks.map((t, i) => {
                const isBi = t.mode === 'bidirectional';
                let badgeHtml = '';

                // [æ ¸å¿ƒä¿®æ”¹] å¾½ç« æ˜¾ç¤ºé€»è¾‘
                if (isBi) {
                    // åŒå‘æ¨¡å¼ï¼šåªæ˜¾ç¤ºâ€œåŒå‘åŒæ­¥â€ï¼Œå®Œå…¨éšè— Source/Dest
                    badgeHtml = `<span class="role role-bi">ğŸ” åŒå‘åŒæ­¥</span>`;
                } else {
                    // å•å‘æ¨¡å¼ï¼šæ˜¾ç¤ºâ€œå•å‘â€ + â€œSource/Destâ€
                    const roleClass = t.role === 'source' ? 'role-src' : 'role-dst';
                    const roleName = t.role === 'source' ? 'Source' : 'Dest';
                    badgeHtml = `<span class="role" style="background:#eee;color:#555;margin-right:4px">â¡ï¸ å•å‘</span>
                                <span class="role ${roleClass}">${roleName}</span>`;
                }
                        
                return `
            <div class="task-card">
            <div class="task-header">
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.sync_folder}">ğŸ“ ${t.sync_folder.split(/[/\\]/).pop() || 'Root'}</span>
            <div style="flex-shrink:0;margin-left:8px">
                ${badgeHtml} </div>
            </div>
            <div class="task-body">
            <div class="info-item">
                <div class="info-label">KEY</div>
                <div class="info-val" onclick="copy('${t.sync_key}')">${t.sync_key}</div>
            </div>
            <div class="info-item">
                <div class="info-label">PATH</div>
                <div class="info-val" title="${t.sync_folder}">${t.sync_folder}</div>
            </div>
            </div>
            <div class="task-footer">
            <button class="btn btn-primary" style="flex:1" onclick="openFolder(${i})">ğŸ“‚ æ‰“å¼€</button>
            <button class="btn" style="flex:1" onclick="viewTaskLog(${i})">ğŸ“„ æ—¥å¿—</button>
            <button class="btn btn-danger" onclick="delTask(${i})">ğŸ—‘</button>
            </div>
            </div>`;
            }).join('');
            } catch (e) { console.error(e) }
        }

        async function loadSettings() {
            try {
                const r = await fetch('/api/config');
                const c = await r.json();
                id('cfgTrackerHost').value = c.tracker_host || "";
                id('cfgTrackerPort').value = c.tracker_port || 9988;
                id('cfgStunHost').value = c.stun_host || "stun.l.google.com";
                id('cfgStunPort').value = c.stun_port || 19302;
                id('cfgTurnHost').value = c.turn_host || "";
                id('cfgTurnPort').value = c.turn_port || 3478;
                id('cfgTurnUser').value = c.turn_username || "";
                id('cfgTurnPass').value = c.turn_password || "";
            } catch (e) {
                console.error("åŠ è½½é…ç½®å¤±è´¥", e);
            }
        }

        async function saveSettings() {
            const b = id('btnSave');
            b.disabled = true;
            b.innerText = "ä¿å­˜ä¸­...";

            const d = {
                tracker_host: id('cfgTrackerHost').value,
                tracker_port: parseInt(id('cfgTrackerPort').value || 0),
                stun_host: id('cfgStunHost').value,
                stun_port: parseInt(id('cfgStunPort').value || 0),
                turn_host: id('cfgTurnHost').value,
                turn_port: parseInt(id('cfgTurnPort').value || 0),
                turn_username: id('cfgTurnUser').value,
                turn_password: id('cfgTurnPass').value
            };

            if (d.tracker_port < 1 || d.stun_port < 1 || (d.turn_host && d.turn_port < 1)) {
                alert("ç«¯å£å·æ— æ•ˆï¼Œè¯·è¾“å…¥ 1-65535 ä¹‹é—´çš„æ•°å­—");
                b.disabled = false;
                b.innerText = "ğŸ’¾ ä¿å­˜è®¾ç½®";
                return;
            }

            try {
                const r = await fetch('/api/config', { method: 'POST', body: JSON.stringify(d) });
                const res = await r.json();
                if (r.ok) {
                    alert("å·²ä¿å­˜ï¼Œè¯·é‡å¯åº”ç”¨ä»¥ç”Ÿæ•ˆ");
                } else {
                    alert("ä¿å­˜å¤±è´¥: " + (res.error || "æœªçŸ¥é”™è¯¯"));
                }
            } catch (e) {
                alert("ç½‘ç»œé”™è¯¯");
            }
            b.disabled = false;
            b.innerText = "ğŸ’¾ ä¿å­˜è®¾ç½®";
        }

        async function restartApp() { if (!confirm("ç¡®å®šè¦é‡å¯å—ï¼Ÿ")) return; id('restart-overlay').classList.add('active'); try { fetch('/api/restart', { method: 'POST' }); } catch (e) { } let c = 0; const t = setInterval(async () => { c++; try { const ctl = new AbortController(); setTimeout(() => ctl.abort(), 2000); const r = await fetch('/api/config', { signal: ctl.signal }); if (r.ok) { clearInterval(t); location.reload(); } } catch (e) { if (c > 30) { clearInterval(t); location.reload(); } } }, 2000); }
        function genKey() { const c = 'abcdefghijklmnopqrstuvwxyz0123456789', l = c.length; let k = 'sync-'; for (let i = 0; i < 8; i++)k += c.charAt(Math.floor(Math.random() * l)); id('newKey').value = k; }
        function closeLogModal() { id('log-modal').classList.remove('open'); }
        async function openFolder(i) { try { const r = await fetch(`/api/tasks/${i}/open`, { method: 'POST' }); if (!r.ok) alert('æ‰“å¼€å¤±è´¥'); } catch (e) { } }
        async function pickFolder() { const b = event.target; b.disabled = true; try { const r = await fetch('/api/utils/pick_folder', { method: 'POST' }); const d = await r.json(); if (d.path) id('newFolder').value = d.path; } catch (e) { } b.disabled = false; }

        async function addTask() { 
            const k = id('newKey').value;
            const m = id('newMode').value;
            const f = id('newFolder').value;
            
            // [æ ¸å¿ƒé€»è¾‘] å¦‚æœæ˜¯åŒå‘æ¨¡å¼ï¼Œå¼ºåˆ¶è§’è‰²ä¸º 'source'ï¼›å¦åˆ™å–ç”¨æˆ·é€‰æ‹©
            const r = (m === 'bidirectional') ? 'source' : id('newRole').value;
            
            if (!k || !f) return alert('ä¿¡æ¯ä¸å®Œæ•´'); 
            
            try {
                const resp = await fetch('/api/tasks', { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        sync_key: k, 
                        role: r, 
                        sync_folder: f,
                        mode: m 
                    }) 
                }); 
                
                if (resp.ok) {
                    closeModal(); 
                    setTimeout(() => { location.reload(); }, 500);
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            } catch(e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        async function delTask(i) { if (confirm('åˆ é™¤?')) { await fetch(`/api/tasks/${i}`, { method: 'DELETE' }); location.reload(); } }

        async function fetchGlobalLog() {
            try {
                const r = await fetch('/api/log');
                rawLog = await r.text();
                renderLog();
            } catch (e) { }
        }

        function renderLog() {
            const f = id('logFilter').value.toLowerCase();
            const e = id('global-log-area');
            const escapeHtml = (text) => text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const lines = rawLog.split('\n');
            let html = '';

            for (const line of lines) {
                if (!line.trim()) continue;
                if (f && !line.toLowerCase().includes(f)) continue;

                let cls = 'log-info';
                if (line.includes('[error]') || line.includes('Error') || line.includes('critical')) cls = 'log-error';
                else if (line.includes('[warn]')) cls = 'log-warn';
                else if (line.includes('[debug]')) cls = 'log-debug';

                const formattedLine = escapeHtml(line).replace(/^\[(.*?)\]/, '<span class="log-time">[$1]</span>');
                html += `<div class="log-line ${cls}">${formattedLine}</div>`;
            }

            e.innerHTML = html;
            if (id('autoScroll').checked) e.scrollTop = e.scrollHeight;
        }

        async function viewTaskLog(i) {
            try {
                const r = await fetch(`/api/tasks/${i}/log`);
                id('task-log-content').innerText = await r.text();
                id('log-modal').classList.add('open');
            } catch (e) { }
        }

        function copy(t) { navigator.clipboard.writeText(t).then(() => alert('å·²å¤åˆ¶')); }
        function openModal() { id('add-modal').classList.add('open'); }
        function closeModal() { id('add-modal').classList.remove('open'); }

        const fi = id('newFolder');
        fi.addEventListener('dragover', e => e.preventDefault());
        fi.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) fi.value = (e.dataTransfer.files[0].path || e.dataTransfer.files[0].name).replace(/\\/g, '/'); });

        setInterval(() => { if (!id('view-logs').classList.contains('section-hidden') && id('autoScroll').checked) fetchGlobalLog() }, 3000);

        // åˆå§‹åŠ è½½
        loadTasks();

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–é€Ÿåº¦
        function formatSpeed(bytesPerSec) {
            return formatSize(bytesPerSec) + '/s';
        }

        // ä¼ è¾“çŠ¶æ€è½®è¯¢
        setInterval(async () => {
            try {
                const r = await fetch('/api/status');
                const data = await r.json();
                const el = id('transfer-container');

                id('transfer-count').innerText = data.length;

                if (data.length === 0) {
                    el.innerHTML = '<div style="text-align:center;padding:1.5rem;color:#9ca3af;font-size:0.9rem">âœ¨ æš‚æ— æ´»è·ƒä¼ è¾“</div>';
                } else {
                    el.innerHTML = data.map(d => {
                        const isUp = (d.type === 'upload');
                        const badgeClass = isUp ? 'badge-up' : 'badge-down';
                        const fillClass = isUp ? 'fill-up' : 'fill-down';
                        const typeText = isUp ? 'UPLOADING' : 'DOWNLOADING';

                        // åç«¯å—å¤§å°å›ºå®šä¸º 16384
                        const CHUNK_SIZE = 16384;
                        const currentBytes = d.done * CHUNK_SIZE;
                        const totalBytes = d.total * CHUNK_SIZE;

                        // ä½¿ç”¨è¾…åŠ©å‡½æ•°æ ¼å¼åŒ–
                        const sizeText = `${formatSize(currentBytes)} / ${formatSize(totalBytes)}`;
                        const speedText = formatSpeed(d.speed || 0); // ä½¿ç”¨åç«¯ä¼ æ¥çš„ speed

                        return `
                    <div class="transfer-item">
                        <div class="transfer-header">
                            <div style="display:flex;align-items:center;gap:8px;overflow:hidden;flex:1">
                                <span class="transfer-badge ${badgeClass}">${typeText}</span>
                                
                                <div style="display:flex;flex-direction:column;overflow:hidden;line-height:1.3;flex:1">
                                    <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;color:#374151;font-size:0.9rem" title="${d.path}">
                                        ${d.path.split(/[/\\]/).pop()}
                                    </span>
                                    <span style="font-size:0.75rem;color:#9ca3af;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${d.root}">
                                        ğŸ“‚ ${d.root}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="font-weight:700;font-family:monospace;margin-left:10px;color:var(--primary);white-space:nowrap">
                                âš¡ ${speedText}
                            </div>
                        </div>
                        
                        <div class="progress-track">
                            <div class="progress-fill ${fillClass}" style="width:${d.progress}%"></div>
                        </div>
                        
                        <div class="transfer-meta" style="margin-top:8px;color:#6b7280;font-size:0.75rem;display:flex;justify-content:space-between;align-items:center">
                            <span style="background:#f3f4f6;padding:2px 6px;border-radius:4px;font-family:monospace;user-select:all;max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${d.key}">
                                ğŸ”‘ ${d.key}
                            </span>
                            
                            <span style="font-weight:500;font-family:monospace">${sizeText}</span>
                        </div>
                    </div>
                `}).join('');
                }
            } catch (e) { }
        }, 500); // ä¿æŒ 500ms çš„åˆ·æ–°é¢‘ç‡
            </script>
        </body>
    </html>
